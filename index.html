<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>BISTEC Care ‚Äî Clinic Capture</title>
</head>

<body style="font-family: Arial, sans-serif; background:#f6f7fb; margin:0; padding:20px;">

  <div style="max-width:420px; margin:0 auto;">

    <!-- Header -->
    <div style="display:flex; align-items:center; gap:12px; margin-bottom:16px;">
      <img src="logo.png" alt="BISTEC Care" style="height:42px;">
      <div style="text-align:left;">
        <div style="font-size:16px; font-weight:700;">Clinic Capture</div>
        <div style="font-size:12px; color:#666;">Field data collection</div>
      </div>
    </div>

    <!-- Main Card -->
    <div style="background:white; border-radius:16px; box-shadow:0 8px 20px rgba(0,0,0,0.06); padding:16px;">

      <!-- Clinic Name -->
      <div style="text-align:left; font-size:13px; color:#333; margin-bottom:6px; font-weight:600;">Clinic Name</div>
      <input type="text" id="clinicName" placeholder="e.g. Smile Dental Clinic"
             style="width:100%; box-sizing:border-box; font-size:16px; padding:12px; border-radius:12px; border:1px solid #ddd; outline:none;">

      <div style="height:12px;"></div>

      <!-- Type + Size -->
      <div style="display:flex; gap:10px;">
        <div style="flex:1;">
          <div style="text-align:left; font-size:13px; color:#333; margin-bottom:6px; font-weight:600;">Type</div>
          <select id="clinicType"
                  style="width:100%; box-sizing:border-box; font-size:16px; padding:12px; border-radius:12px; border:1px solid #ddd;">
            <option value="Dental">Dental</option>
            <option value="Skin">Skin</option>
            <option value="Other">Other</option>
          </select>
        </div>

        <div style="flex:1;">
          <div style="text-align:left; font-size:13px; color:#333; margin-bottom:6px; font-weight:600;">Size</div>
          <select id="clinicSize"
                  style="width:100%; box-sizing:border-box; font-size:16px; padding:12px; border-radius:12px; border:1px solid #ddd;">
            <option value="Small">Small</option>
            <option value="Medium">Medium</option>
            <option value="Large">Large</option>
          </select>
        </div>
      </div>

      <div style="height:14px;"></div>

      <!-- Lead Type (optional) -->
      <div style="text-align:left; font-size:13px; color:#333; margin-bottom:6px; font-weight:600;">
        Lead Type <span style="font-weight:500; color:#888;">(optional)</span>
      </div>

      <div style="display:flex; gap:12px; align-items:center; justify-content:flex-start; flex-wrap:wrap; margin-bottom:12px;">
        <label style="display:flex; align-items:center; gap:8px; padding:10px 12px; border:1px solid #ddd; border-radius:12px; background:#fff; cursor:pointer;">
          <input type="radio" name="leadType" value="Lead" onchange="onLeadTypeChange()">
          <span style="font-size:14px; font-weight:700;">Lead</span>
        </label>

        <label style="display:flex; align-items:center; gap:8px; padding:10px 12px; border:1px solid #ddd; border-radius:12px; background:#fff; cursor:pointer;">
          <input type="radio" name="leadType" value="Prospect" onchange="onLeadTypeChange()">
          <span style="font-size:14px; font-weight:700;">Prospect</span>
        </label>

        <button type="button" onclick="clearLeadType()"
                style="border:0; background:transparent; color:#666; font-size:13px; font-weight:700; padding:6px 4px; cursor:pointer;">
          Clear
        </button>
      </div>

      <!-- Priority (optional) -->
      <div style="text-align:left; font-size:13px; color:#333; margin-bottom:6px; font-weight:600;">
        Priority <span style="font-weight:500; color:#888;">(optional)</span>
      </div>

      <div style="display:flex; gap:12px; align-items:center; justify-content:flex-start; flex-wrap:wrap; margin-bottom:14px;">
        <label style="display:flex; align-items:center; gap:8px; padding:10px 12px; border:1px solid #ddd; border-radius:12px; background:#fff; cursor:pointer;">
          <input type="radio" name="priority" value="High" onchange="onPriorityChange()">
          <span style="font-size:14px; font-weight:700;">High</span>
        </label>

        <label style="display:flex; align-items:center; gap:8px; padding:10px 12px; border:1px solid #ddd; border-radius:12px; background:#fff; cursor:pointer;">
          <input type="radio" name="priority" value="Medium" onchange="onPriorityChange()">
          <span style="font-size:14px; font-weight:700;">Medium</span>
        </label>

        <label style="display:flex; align-items:center; gap:8px; padding:10px 12px; border:1px solid #ddd; border-radius:12px; background:#fff; cursor:pointer;">
          <input type="radio" name="priority" value="Low" onchange="onPriorityChange()">
          <span style="font-size:14px; font-weight:700;">Low</span>
        </label>

        <button type="button" onclick="clearPriority()"
                style="border:0; background:transparent; color:#666; font-size:13px; font-weight:700; padding:6px 4px; cursor:pointer;">
          Clear
        </button>
      </div>

      <!-- Photo buttons -->
      <div style="display:flex; gap:10px;">
        <button type="button" onclick="openCamera()"
                style="flex:1; border:0; border-radius:14px; padding:12px; font-size:15px; font-weight:700; background:#0b5cff; color:white;">
          üì∏ Take Photos
        </button>

        <button type="button" onclick="openGallery()"
                style="flex:1; border:1px solid #ddd; border-radius:14px; padding:12px; font-size:15px; font-weight:700; background:#fff;">
          üñºÔ∏è Gallery
        </button>
      </div>

      <!-- Location box -->
      <div id="locationBox"
           style="margin-top:12px; background:#f3f6ff; border:1px solid #dbe6ff; border-radius:14px; padding:10px; text-align:left; font-size:13px; display:none;">
      </div>

      <!-- Status -->
      <div id="status"
           style="margin-top:12px; font-size:14px; font-weight:700; color:#333; text-align:left;">
      </div>

      <!-- Submit -->
      <button onclick="submitData()"
              style="margin-top:14px; width:100%; border:0; border-radius:14px; padding:14px; font-size:16px; font-weight:800; background:#12b76a; color:white;">
        ‚úÖ Submit
      </button>

      <!-- Selected photos moved below submit -->
      <div id="photoInfo" style="margin-top:12px; font-size:13px; color:#333; text-align:left; font-weight:700;"></div>
      <div id="photoList" style="margin-top:6px; text-align:left; font-size:13px;"></div>

      <!-- Pilot debug toggle -->
      <div style="margin-top:12px; display:flex; align-items:center; justify-content:space-between; font-size:13px; color:#666;">
        <span>Pilot Mode: Show debug</span>
        <input type="checkbox" id="showDebugToggle" onchange="refreshDebugUI()">
      </div>

      <!-- Debug panel -->
      <div id="debugBox"
           style="margin-top:10px; display:none; background:#111; color:#fff; border-radius:12px; padding:10px; font-size:12px; text-align:left; white-space:pre-wrap;">
      </div>

    </div>

    <div style="font-size:12px; color:#888; margin-top:12px; text-align:center;">
      BISTEC Care ‚Ä¢ Field Capture Pilot
    </div>

  </div>

  <!-- Hidden inputs -->
  <input type="file" id="cameraInput" accept="image/*" capture="environment" multiple style="display:none;"
         onchange="handleFiles(this.files, 'camera')">

  <input type="file" id="galleryInput" accept="image/*" multiple style="display:none;"
         onchange="handleFiles(this.files, 'gallery')">

<script>
/** ===============================
 * CONFIG
 * =============================== */
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzj1dwf7pPHYBbLBgyHZObxLNWw4UmCvEeerYrkTCpyIYc4oLcKtMz3wByMeSJ8pYmr7w/exec";
const MAX_PHOTOS = 5;
const MAX_WIDTH = 1024;
const JPEG_QUALITY = 0.6;

/** ===============================
 * STATE
 * =============================== */
let selectedItems = []; // { name, type, buffer }
let photoSource = null;
let gpsSource = "PHONE";

// optional values
let leadType = "";
let priority = "";

// debug buffer sent to sheet
let debugBuffer = "";

/** ===============================
 * Debug helpers
 * =============================== */
function clearDebug() {
  debugBuffer = "";
  refreshDebugUI();
}
function appendDebug(line) {
  debugBuffer += (debugBuffer ? "\n" : "") + line;
  refreshDebugUI();
}
function refreshDebugUI() {
  const show = document.getElementById("showDebugToggle")?.checked;
  const box = document.getElementById("debugBox");
  if (!box) return;

  if (show) {
    box.style.display = "block";
    box.textContent = debugBuffer || "(empty)";
  } else {
    box.style.display = "none";
  }
}

/** ===============================
 * Lead/Priority radio logic
 * =============================== */
function onLeadTypeChange() {
  leadType = document.querySelector('input[name="leadType"]:checked')?.value || "";
  appendDebug("LeadType: " + (leadType || "(empty)"));
}
function clearLeadType() {
  document.querySelectorAll('input[name="leadType"]').forEach(r => r.checked = false);
  leadType = "";
  appendDebug("LeadType cleared");
}
function onPriorityChange() {
  priority = document.querySelector('input[name="priority"]:checked')?.value || "";
  appendDebug("Priority: " + (priority || "(empty)"));
}
function clearPriority() {
  document.querySelectorAll('input[name="priority"]').forEach(r => r.checked = false);
  priority = "";
  appendDebug("Priority cleared");
}

/** ===============================
 * Buttons
 * =============================== */
function openCamera() {
  document.getElementById("cameraInput").click();
}
function openGallery() {
  document.getElementById("galleryInput").click();
}

/** ===============================
 * File handling (store in memory immediately)
 * =============================== */
async function handleFiles(files, source) {
  photoSource = source;

  clearDebug();
  setStatus("");
  hideLocationBox();

  appendDebug("Photo source: " + source.toUpperCase());

  const newFiles = [...files];
  appendDebug("New files: " + newFiles.map(f => f.name).join(", "));

  // reset pickers
  document.getElementById("cameraInput").value = "";
  document.getElementById("galleryInput").value = "";

  for (const f of newFiles) {
    if (selectedItems.length >= MAX_PHOTOS) {
      appendDebug("‚ö†Ô∏è Max photos reached: " + MAX_PHOTOS);
      alert("Max " + MAX_PHOTOS + " photos per clinic");
      break;
    }

    try {
      appendDebug("Reading into memory: " + f.name);
      const buffer = await f.arrayBuffer();
      selectedItems.push({ name: f.name, type: f.type || "image/jpeg", buffer });
      appendDebug("‚úÖ Stored: " + f.name + " (" + buffer.byteLength + " bytes)");
    } catch (err) {
      appendDebug("‚ùå Read failed: " + f.name + " | " + (err?.message || String(err)));
      alert("Cannot read selected file: " + f.name);
    }
  }

  updatePhotoUI();
}

/** ===============================
 * Photo list UI
 * =============================== */
function removePhoto(index) {
  selectedItems.splice(index, 1);
  updatePhotoUI();
  appendDebug("Removed photo index: " + index);
}

function updatePhotoUI() {
  const info = document.getElementById("photoInfo");
  const list = document.getElementById("photoList");

  if (!selectedItems.length) {
    info.innerText = "";
    list.innerHTML = "";
    return;
  }

  info.innerText = `‚úÖ ${selectedItems.length} photo(s) selected`;

  list.innerHTML = `
    <ul style="margin:6px 0 0 0; padding-left:18px;">
      ${selectedItems.map((it, idx) => `
        <li style="margin-bottom:6px; display:flex; align-items:center; gap:10px;">
          <span style="flex:1; word-break:break-word;">${escapeHtml(it.name)}</span>
          <button type="button"
                  onclick="removePhoto(${idx})"
                  style="font-size:12px; padding:6px 10px; border-radius:10px; border:1px solid #ddd; background:#fff;">
            Remove
          </button>
        </li>
      `).join("")}
    </ul>
  `;
}

/** ===============================
 * GPS
 * =============================== */
function getDeviceGps() {
  return new Promise((resolve, reject) => {
    navigator.geolocation.getCurrentPosition(
      (pos) => resolve({ lat: pos.coords.latitude, lng: pos.coords.longitude }),
      (err) => reject(err),
      { enableHighAccuracy: true, timeout: 15000 }
    );
  });
}

/** ===============================
 * UI helpers
 * =============================== */
function setStatus(text) {
  document.getElementById("status").innerText = text || "";
}
function hideLocationBox() {
  const box = document.getElementById("locationBox");
  box.style.display = "none";
  box.innerHTML = "";
}
function showLocationBox(lat, lng, label) {
  const box = document.getElementById("locationBox");
  const mapUrl = `https://www.google.com/maps?q=${lat},${lng}`;
  box.style.display = "block";
  box.innerHTML = `
    <div style="font-weight:800; margin-bottom:6px;">üìç Location</div>
    <div style="font-size:12px; color:#333;">GPS Source: <b>${escapeHtml(label)}</b></div>
    <div style="margin-top:6px;">Lat: ${lat}</div>
    <div>Lng: ${lng}</div>
    <div style="margin-top:6px;">
      <a href="${mapUrl}" target="_blank">Open in Google Maps</a>
    </div>
  `;
}

/** ===============================
 * Compress + base64
 * =============================== */
function itemToBlob(item) {
  return new Blob([item.buffer], { type: item.type || "image/jpeg" });
}
async function itemToBase64Compressed(item) {
  const blob = itemToBlob(item);
  const imgBitmap = await createImageBitmap(blob);

  const scale = Math.min(1, MAX_WIDTH / imgBitmap.width);
  const canvas = document.createElement("canvas");
  canvas.width = Math.round(imgBitmap.width * scale);
  canvas.height = Math.round(imgBitmap.height * scale);

  const ctx = canvas.getContext("2d");
  ctx.drawImage(imgBitmap, 0, 0, canvas.width, canvas.height);

  const dataUrl = canvas.toDataURL("image/jpeg", JPEG_QUALITY);
  const base64 = dataUrl.split(",")[1];

  return {
    base64,
    fileName: item.name.replace(/\.[^/.]+$/, "") + "_compressed.jpg",
    mimeType: "image/jpeg"
  };
}

/** ===============================
 * SUBMIT
 * =============================== */
async function submitData() {
  const clinicName = document.getElementById("clinicName").value.trim();
  const clinicType = document.getElementById("clinicType").value;
  const clinicSize = document.getElementById("clinicSize").value;

  // optional: leadType & priority can be blank
  if (!clinicName) return alert("Enter clinic name");
  if (!selectedItems.length) return alert("Select at least 1 photo");

  appendDebug("\n--- Submit ---");
  appendDebug("Clinic: " + clinicName);
  appendDebug("Type: " + clinicType + ", Size: " + clinicSize);
  appendDebug("LeadType: " + (leadType || "(empty)"));
  appendDebug("Priority: " + (priority || "(empty)"));
  appendDebug("Photos: " + selectedItems.length);

  setStatus("üìç Getting phone GPS...");
  hideLocationBox();

  let lat, lng;
  try {
    const deviceGps = await getDeviceGps();
    lat = deviceGps.lat;
    lng = deviceGps.lng;
    showLocationBox(lat, lng, "Phone GPS");
  } catch (err) {
    appendDebug("‚ùå Phone GPS failed: " + (err?.message || String(err)));
    setStatus("‚ùå GPS failed");
    return alert("Unable to fetch phone location. Enable GPS.");
  }

  setStatus("üñºÔ∏è Preparing images...");
  appendDebug("\n--- Image Compression ---");

  const images = [];
  for (const it of selectedItems) {
    appendDebug("Compressing: " + it.name);
    const img = await itemToBase64Compressed(it);
    images.push(img);
    appendDebug("Done: " + img.fileName + " | base64=" + img.base64.length);
  }

  const payload = {
    latitude: lat,
    longitude: lng,
    clinicName,
    clinicType,
    clinicSize,
    images,
    leadType: leadType || "",
    priority: priority || "",
    photoSource: (photoSource || "").toUpperCase(),
    gpsSource: gpsSource || "PHONE",
    debugLog: debugBuffer
  };

  const payloadStr = JSON.stringify(payload);
  appendDebug("\n--- Upload ---");
  appendDebug("Payload chars: " + payloadStr.length);

  setStatus("‚òÅÔ∏è Uploading...");

  try {
    const resp = await fetch(WEB_APP_URL, {
      method: "POST",
      headers: { "Content-Type": "text/plain;charset=utf-8" },
      body: payloadStr
    });

    const respText = await resp.text();
    appendDebug("HTTP: " + resp.status);
    appendDebug("Response: " + respText);

    if (!resp.ok) {
      setStatus("‚ùå Upload failed");
      return alert("Upload failed (HTTP " + resp.status + ")");
    }

    setStatus("‚úÖ Submitted successfully");

    // reset form
    selectedItems = [];
    photoSource = null;

    document.getElementById("clinicName").value = "";
    document.getElementById("photoInfo").innerText = "";
    document.getElementById("photoList").innerHTML = "";
    hideLocationBox();

  } catch (err) {
    appendDebug("‚ùå Upload error: " + (err?.message || String(err)));
    setStatus("‚ùå Upload failed");
    alert("Upload failed. Please try again.");
  }
}

/** ===============================
 * SAFE TEXT
 * =============================== */
function escapeHtml(str) {
  return String(str).replace(/[&<>"']/g, (m) => ({
    "&": "&amp;",
    "<": "&lt;",
    ">": "&lt;",
    '"': "&quot;",
    "'": "&#039;"
  })[m]);
}
</script>

</body>
</html>
